<!DOCTYPE html>
<html>
<head>
   <title>Appendix &gt; Class Dictionary &gt; TLB and PTE Bit-Shift Consistency</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />   
   <meta http-equiv="X-UA-Compatible" content="IE=edge" />
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta name="description" content="All TLB and PTE lookups, as well as insert and invalidate operations, must use the page shift (bit shift) associated with each entry. This ensures that the virtual page number..." />
   <link type="text/css" href="default.css" rel="stylesheet" />
   <link type="text/css" href="custom.css" rel="stylesheet" />

   <style TYPE="text/css" media="screen"> 
      html, body { margin:0; 
        padding:0; 
        background: #ffffff; 
      } 
      div#printheader { display: none; }
      #idheader { 
        width:100%; 
        min-height: 60px; 
        padding: 0; 
        margin: 0;
        position: fixed;
        top: 0;
        background: #2C5D88;
        z-index: 2;
      } 
      /* The "min-height" for "#idheader table" ensures that the (blue) header of the topic
         has at least the same height as the header of the navigation panel left of it */
      #idheader table { min-height: 59px;}             
      #idheader h1 span { color: #FFF }     
      #idnav {
        text-align: right;
        width: 126px;
        vertical-align: middle;        
      } 
      #idnav a { text-decoration: none }
      #idnav span {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-left: 4px;
        background:url('hm_webhelp_buttons_grey.png') top left no-repeat;
      } 
      #idnav a span {
        background-image:url('hm_webhelp_buttons_white.png');
      } 
      #idnav a span:hover {
        background-image:url('hm_webhelp_buttons_orange.png');
      } 
      #idnav span.hmbtnprev { background-position: 0 -32px }
      #idnav span.hmbtnnext { background-position: -24px -32px }
      #idnav span.hmbtntop  { background-position: -48px -32px }
      #idnav span.hmbtntoggle  { width: 20px; background-position: -70px -32px }
      #idnav span.hmbtnprint  { background-position: -88px -32px }

      #callout-table, #overview-table {display:block; position:relative; top:0; left:0;}
      #callout-icon {display:block; position:absolute; top:-11px; left:-11px;}
      #callout-icon-flag {display:block; position:absolute; top:-11px; left:-8px;}
      #callout-table a {text-decoration: none; color: blue;}
      #callout-table a:visited {text-decoration: none; color: blue;}
      #overview-table a {text-decoration: none; color: black;}
      #overview-table a:visited {text-decoration: none; color: black;}
      #callout-table a:hover, #overview-table a:hover {text-decoration: underline;}       
      p.help-url { margin: 20px 0 5px 0; text-align: center; }
	  p.help-url a:link { font-size: 50%; text-decoration: none; color: black; }
	  p.help-url a:visited { color: black; }
	  p.help-url a:hover { font-size: 95%; text-decoration: underline; }
      #switchtoggles { text-align: right; padding: 0 2px 0 0; font-size: 90%; } 
      .sync-toc { color: #FFF; font-size: 8pt; font-weight: bold; display: none; }
      .sync-toc a { color: #FFF; text-decoration: none; font-weight: bold;}
      .sync-toc a:visited { color: #FFF; }
      .sync-toc a:hover { text-decoration: underline; }
	  a#printbuttonlink { cursor: pointer; }
      a.hmanchor { display: inline-block; margin-top: -4em; padding-top: 4em; }  
   </style>
   <style TYPE="text/css" media="print">
      div#idheader, img.dropdown-toggle-icon, p.help-url { display:none } 
   </style>
   
   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>

   <script type="text/javascript">
     HMSyncTOC("index.html", "tlbentry-superpages.html");
   </script>
   <script type="text/javascript" src="highlight.js"></script>
   <script type="text/javascript">
     $(document).ready(function(){highlight();});
   </script>
</head>
<body>


<div id="printheader"><h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">TLB and PTE Bit-Shift Consistency</span></h1>
</div>
<div id="idheader">
<div id="idheaderbg">
<table style="width:100%;border:none;margin:0px;" cellspacing="0" cellpadding="0"> 
  <tr>
    <td class="topichead" style="text-align:left; vertical-align:middle">
      <p class="sync-toc">&lt;&lt; <a rel="nofollow" href="index.html?tlbentry-superpages.html" target="_top">Click to Display Table of Contents</a> &gt;&gt;</p>
      <p class="crumbs"><b>Navigation:</b>&nbsp;
      
      Appendix &gt; Class Dictionary&nbsp;&gt;</p>
   
      <h1 class="p_Heading1" style="page-break-after: avoid;"><span class="f_Heading1">TLB and PTE Bit-Shift Consistency</span></h1>

    </td>
    <td class="topichead" id="idnav">
      
      <a href="kzpsa-systembus.html" title="Previous Topic"><span class="hmbtnprev"></span></a>
      <a href="introduction.html" title="Parent Chapter"><span class="hmbtntop"></span></a>
      <a href="tlb-and-pte-invalidation.html" title="Next Topic"><span class="hmbtnnext"></span></a>
      
    </td>
  </tr>  
</table>
</div>
</div>  

<div id="idcontent"><div id="innerdiv">
<!-- Ask Internet Explorer 6.users to update their obsolete and dangerous browser --> 
<!--[if lt IE 7]><div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;'><a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." /></a></div><![endif]-->

<!--ZOOMRESTART-->
<p class="p_Normal">All TLB and PTE lookups, as well as insert and invalidate operations, must use the page shift (bit shift) associated with each entry. This ensures that the virtual page number (VPN) and physical page number (PPN) are calculated and matched consistently for standard pages (8KB) and superpages (64KB, 4MB, 256MB).</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">The default shift is 13 bits for an 8192 byte page. </p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Alpha AXP and Most RISC Architectures</span></h3>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>The standard Alpha AXP page size is 8KB = 8192 bytes.</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>Shifting by 13 to compute the VPN or PPN is standard for 8KB pages.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">Reference Table</p>
<div style="text-align: left; text-indent: 0; padding: 0 0 0 0; margin: 0 0 0 0;"><table style="border:none; border-spacing:0; border-collapse:collapse;">
<thead>
<tr>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Page Size</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Shift Amount</span></p>
</th>
<th style="vertical-align:top; background-color:#00FFFF; padding:0; border:solid thin #000000;" scope="col"><p class="p_Normal"><span style="font-weight: bold;">Value</span></p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">8KB</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">13 (D)</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">8192 bytes</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">64KB</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">16</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">65536 bytes</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">4MB</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">22</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">4,194,304 bytes</p>
</td>
</tr>
<tr>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">256MB</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">28</p>
</td>
<td style="vertical-align:top; padding:0; border:solid thin #000000;"><p class="p_Normal">268,435,456 bytes</p>
</td>
</tr>
</tbody>
</table>
</div>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;">Alpha provides PALcode instructions for:</span></p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>TBISI — Invalidate Single ITB entry (Instruction)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>TBISD — Invalidate Single DTB entry (Data)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>TBIS — Invalidate both (usually by calling both)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>TBIA — Invalidate all (rare, system-wide events)</p>
<p class="p_Normal" style="text-indent: 0; padding-left: 13px; margin-left: 0;"><span class="f_Normal" style="font-family: Arial,'Lucida Sans Unicode','Lucida Grande','Lucida Sans';display:inline-block;width:13px;margin-left:-13px">&#8226;</span>TBIAP - Invakudate all TLB entr8ies for a given ASN on a single CPU</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Reference:</span></h3>
<p class="p_Normal"> &nbsp; &nbsp;&quot;All TLB and PTE lookups, as well as insert and invalidate operations, must use the page shift associated with the entry. For 8KB pages the shift is 13, for superpages use the superpage encoding.&quot; &nbsp;— Alpha AXP System Reference Manual, Section 5.2–5.3</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;In this system, the bit shift value is passed to the TLBEntry via the constructor. &nbsp;This guarantees that every insert, lookup, and invalidate operation always uses the correct page size and shift for virtual and physical address translation.</p>
<p class="p_Normal">&nbsp;</p>
<h3 class="p_Heading3" style="page-break-after: avoid;"><span class="f_Heading3">Examples: </span></h3>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;"> &nbsp;Example: 64KB Superpage (page shift 16)</span></p>
<p class="p_Normal"><span style="font-style: italic;"> &nbsp; &nbsp; Creating a temporary entry to compute VPN for a 64KB page:</span></p>
<p class="p_CodeExample">&nbsp;&nbsp;<span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;TLBEntry&nbsp;tmpEntry(virtualAddr,&nbsp;16);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Bit-Shift&nbsp;by&nbsp;16&nbsp;bits</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;quint64&nbsp;vpn&nbsp;=&nbsp;tmpEntry.virtualPageNumber();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;VPN&nbsp;from&nbsp;16-bit&nbsp;shift</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;TLBEntryKey&nbsp;key{&nbsp;cpuId,&nbsp;vpn,&nbsp;asn&nbsp;};&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;TLB&nbsp;key&nbsp;for&nbsp;lookup/invalidate</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;auto&nbsp;it&nbsp;=&nbsp;m_tlbEntries.find(key);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Find&nbsp;entry&nbsp;by&nbsp;key</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;</span></p>
<p class="p_Normal"><span style="font-weight: bold;"> &nbsp;Example: Inserting a superpage mapping</span></p>
<p class="p_CodeExample">&nbsp;&nbsp;&nbsp;<span class="f_CodeExample" style="font-size: 11px;">&nbsp;TLBEntry&nbsp;entry(virtualAddr,&nbsp;16);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Use&nbsp;shift&nbsp;16&nbsp;for&nbsp;64KB&nbsp;page</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;entry.setAsn(asn);</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;TLBEntryKey&nbsp;key{&nbsp;cpuId,&nbsp;entry.virtualPageNumber(),&nbsp;entry.Asn()&nbsp;};</span></p>
<p class="p_CodeExample"><span class="f_CodeExample" style="font-size: 11px;">&nbsp;&nbsp;&nbsp;&nbsp;m_tlbEntries[key]&nbsp;=&nbsp;entry;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Insert&nbsp;into&nbsp;TLB</span></p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"><span style="font-weight: bold;"> &nbsp;Best Practice:</span></p>
<p class="p_Normal"> &nbsp; &nbsp;- Always use the TLBEntry constructor with the correct page shift (13 for 8KB, 16 for 64KB, etc.).</p>
<p class="p_Normal"> &nbsp; &nbsp;- Never perform the bit shift externally—centralize all VPN/PPN conversion logic in TLBEntry.</p>
<p class="p_Normal"> &nbsp; &nbsp;- This pattern guarantees correctness for both base and superpage MMU support.</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal"> &nbsp;See also: Alpha AXP SRM, Section 5.2–5.3; <a href="tlbentry-class-dictionary.html" class="topiclink">TLBEntry</a> &nbsp;constructor; virtualPageNumber().</p>
<p class="p_Normal">&nbsp;</p>
<p class="p_Normal">&nbsp;</p>

<!--ZOOMSTOP-->
</div></div>
<script type="text/javascript">



function normHeaders() {
 var topicHeadHeight =  $("#idheaderbg > table").first().height() + 1,
	 $topicHeaderBox = $("#idheader"),
	 $topicContentBox = $("#idcontent"),
	 $navHeader = $("#navbar", parent.document),			 
	$navBox = $("div#hmnavframe", parent.document),
	 navHeaderHeight = $navHeader.height();
 if (topicHeadHeight != navHeaderHeight) {
	 $navHeader.css("height",topicHeadHeight + "px");
	 $navBox.css("top", topicHeadHeight + "px");
	 $topicHeaderBox.css("height", topicHeadHeight + "px");
		if ($topicHeaderBox.css("position") == "fixed"){
			$topicContentBox.css("margin-top", topicHeadHeight + "px");
			}
		}
    }
			 
  $(document).ready(function(){
    $(window).on('resize', function() {
      var y = $('#idheader').height(); 
      $('#idcontent').css('margin-top', y);
      var par = window.parent;
      if ($( par ).width() <= $( window ).width()+20) {
        $('#idheader').css('position', 'relative');
        $('#idcontent').css('margin-top', 0);
        $('#idbacktotop').css('display', 'block');
        $('.hmanchor').css('margin-top', -20);
	$('.hmanchor').css('padding-top', 20);
      }
      else {
        $('#idheader').css('position', 'fixed');
        $('#idcontent').css('margin-top', $('#idheader').height());
        $('#idbacktotop').css('display', 'none');
        $('.hmanchor').css('margin-top', -y-20);
		$('.hmanchor').css('padding-top', y+20);
		$("div#hmsplitter", parent.document).css('width', '3px');
      }
	normHeaders();
    });
    
	 $(window).resize(); //trigger event for initially small displays
  });
 

if ((!parent.hmNavigationFrame) && (parent.location) && (parent.location.href)) { $('.sync-toc').show();$('p.crumbs').hide();}

</script>
</body>
</html>
